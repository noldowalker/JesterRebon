# Архитектура поведения неигровых персонажей

За контроль неигровых персонажей отвечает система NpcActorsSystem или ее наследники. Для работы системы необходимы:
1. Набор точек для спавна врагов List<SpawnPoint>
2. Набор врагов для текущего уровня NpcActorsLevelCollection
3. Нужно установить 2 игровых объекта для контроля в иерархии сцены набороов активных их готовызх к спауну врагов, а так же в случае с пулом - точки их размещения.

## Инициация

На этапе инициации система готовится запускать первую волну для первой комнаты.  
Создается пул врагов на ВЕСЬ УРОВЕНЬ и в неактивном состоянии размещается в точке трансформе помеченном как `poolEnemiesContainer`.
Враги создаются по волнам с первой по последнюю, таким образом они извлекаются просто в порядке ОЧЕРЕДИ.
Если на сцене где-то размещены `NpcActor`, они считаюбтся активными и добавляются в коллекцию активных акторов, после чего после старта игры будут действовать как часть первой волны.

ВАЖНО: точки для спавна устанавливаются не на этапе инициации, а отдельным методом, вызываемым из Мастер-системы.

## Рабочий процесс

Из мастер системы идет следующий вызов:

    private void ProcessNpc()
        {
            if (_npcActorsSystem.IsWaveDefeated)
                _npcActorsSystem.PrepareNextWaveForSpawn();
            
            _npcActorsSystem.EnemiesSpawn();
            _npcActorsSystem.EnemiesAct();
        }

### Создание NPC
EnemiesSpawn отвечает за спавн врагов для текущей волны. Спавн отсчитывает время прошедшее с момента предыдущего спавна, если оно превышает 
длительность спавна волны то спавнится новый враг, который удаляется из пула подготовленных и добавляется в пул активных врагов. 
Счетчик времени сбрасывается. Если у текущей волны заспавнены все враги, то спавн останавливается.

### Управление NPC
EnemiesAct перебирает активных врагов и активирует у них метод `Act`.
Метод `NpcActor.Act()` у текущего врага берет текущее его поведение и вызывает у него метод `Act`. 

Каждое поведение является наследником AbstractBehaviour, которое обзует создать реализацию трех методов:

`OnStart` - вызывается при переходе в это поведение, инициирует его.

`Act` - основной метод поведение, итерируется пока не будет выполнено условие окончания. Если в `Act` было установлено,
что поведение выполнило свою функцию, дергается `public Action onBehaviourEnd` а так же вызывается `OnEnd` данного поведения.
`onBehaviourEnd` - это delegate на который при переходе к действию подписывается NpcActor, и подписывается он методом смены действия на `Idle`. 
Поведение `Idle` есть у каждого персонажа. Вся его суть заключатеся в том, что берется указанную в настроке поведения паузу и потом вызывает
метод `MakeDecision`. Данный метод на основе текущего состояния персонажа решает какое поведение ему нужно выбрать как текущее.

`OnEnd` - метод поведения который переводит поведение в "спящее", "пассивное состояние". У некоторых поведений это означает, что
оно не делает ничего. Но у некоторых оно может все еще выполнять проверку некоторых параметров. Например зрение проверяет не вышел ли персонаж за его границы.
Сам метод сугубо внутренний и не должен трогать параметры вне самого поведения.

Итого, говоря проще:
Каждый персонаж обуславливается поведениями на него набросанными. Они работают по паттерну `BehaviourTree`, т.е. при смене состояния
мы возвращаемся к корневому элементу - состоянию `Idle`, которое запускает процесс выбора следующего состояния.

### Переключение волны
Как только в `EnemiesAct` станет понятно, что `_activeEnemies.Count == 0`, т.е. не осталось врагов, чье поведение надо отработать,
утанавливается флаг `IsWaveDefeated`. Мастер система при каждом вызове проверяет этот флаг и в случае если его увидит - запускает 
процесс переключения волны в системе управления НПС - `PrepareNextWaveForSpawn`

Из настроек комнаты берется следующая волна, переустанавливается счетчик спавна врагов на эту волну, сбрасывается таймер спавна и фолаг окончания волны.
Цикл повторяется снова.

